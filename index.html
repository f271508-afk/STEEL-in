<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­é‹¼æé‡é‡æŸ¥è©¢å·¥å…· (ä½œè€…ï¼šæ—æœ¨æ¬‰)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        /* å…¨åŸŸåŸºç¤å­—é«” 21px */
        html { font-size: 21px; }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9; 
            line-height: 1.6;
        }
        
        .active-category {
            background-color: #0f172a !important;
            color: white !important;
            border-color: #0f172a !important;
            transform: scale(1.03);
        }
        
        .drop-zone { 
            border: 3px dashed #94a3b8; 
            transition: all 0.3s; 
            background: #fff;
            padding: 1.2rem 1rem;
        }
        
        .drop-zone.dragover { 
            border-color: #3b82f6; 
            background-color: #eff6ff; 
        }
        
        .custom-card { 
            box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.1); 
        }
        
        input::-webkit-outer-spin-button, 
        input::-webkit-inner-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        input, select, button {
            min-height: 3.5rem;
        }

        .total-weight-number {
            font-size: 2.6rem;
            line-height: 1;
        }
    </style>
</head>
<body class="p-4 md:p-6">

    <div class="max-w-4xl mx-auto">
        <!-- é é¦–å€åŸŸï¼šæ–‡å­—ç½®å³èª¿æ•´ -->
        <div class="bg-slate-900 text-white p-6 md:p-8 rounded-t-[2.5rem] shadow-2xl relative overflow-hidden">
            <div class="relative z-10 flex flex-col md:flex-row md:items-end md:justify-between gap-2">
                <div class="text-center md:text-left">
                    <h1 class="text-3xl font-black flex items-center justify-center md:justify-start gap-4">
                        <span>ğŸ—ï¸</span> é‹¼æè¦æ ¼æŸ¥è©¢ç³»çµ±
                    </h1>
                </div>
                <div class="text-center md:text-right">
                    <p class="text-slate-400 text-base font-medium">ä½œè€…ï¼šæ—æœ¨æ¬‰ 2025/12/30</p>
                </div>
            </div>
            <!-- èƒŒæ™¯è£é£¾ -->
            <div class="absolute right-[-20px] top-[-20px] opacity-10 text-[8rem] pointer-events-none">ğŸ—ï¸</div>
        </div>

        <!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
        <div id="uploadSection" class="bg-white p-6 border-b border-slate-100">
            <label class="block text-slate-700 font-bold mb-4 text-lg flex items-center gap-3">
                <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                ä¸Šå‚³ Excel æ•¸æ“šæº
            </label>
            <div id="dropZone" class="drop-zone rounded-3xl text-center cursor-pointer hover:border-blue-400">
                <input type="file" id="fileInput" multiple accept=".xlsx, .xls" class="hidden">
                <div class="text-slate-500">
                    <p class="text-xl mb-1 font-black text-slate-700">é»æ“Šæˆ–æ‹–å…¥æª”æ¡ˆ</p>
                    <p class="text-sm">æ”¯æ´æ‰€æœ‰é‹¼æ Excel è¦æ ¼è¡¨</p>
                </div>
            </div>
            <div id="fileStatus" class="mt-4 flex flex-wrap gap-2 text-sm"></div>
        </div>

        <!-- æŸ¥è©¢èˆ‡è¨ˆç®—å€åŸŸ -->
        <div id="queryUI" class="bg-white p-8 rounded-b-[2.5rem] custom-card space-y-8 opacity-40 pointer-events-none transition-opacity duration-500">
            
            <!-- é‹¼æåˆ†é¡ -->
            <div>
                <label class="block text-slate-700 font-bold mb-4 text-lg flex items-center gap-3">
                    <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                    é¸æ“‡é‹¼æç¨®é¡
                </label>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3" id="categoryGrid"></div>
            </div>

            <!-- è¦æ ¼é¸å– -->
            <div>
                <label class="block text-slate-700 font-bold mb-4 text-lg flex items-center gap-3">
                    <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
                    é¸å–è¦æ ¼
                </label>
                <div class="relative">
                    <select id="sizeSelect" onchange="handleSizeSelect()" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all text-xl font-bold appearance-none">
                        <option value="">-- è«‹å…ˆä¸Šå‚³ä¸¦é¸æ“‡ç¨®é¡ --</option>
                    </select>
                    <div class="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 text-xl">â–¼</div>
                </div>
            </div>

            <!-- å‹•æ…‹èª¿æ•´æ¬„ä½ -->
            <div id="adjustableFields" class="grid grid-cols-2 sm:grid-cols-4 gap-4 p-6 bg-blue-50 rounded-[2rem] border-2 border-blue-100 hidden">
                <div class="col-span-full flex justify-between items-center mb-2">
                    <span class="text-blue-800 text-xs font-black uppercase tracking-widest">å°ºå¯¸å¾®èª¿</span>
                    <span id="calcModeLabel" class="text-[10px] bg-blue-200 text-blue-800 px-3 py-1 rounded-full font-bold">æ•¸æ“šæ¨¡å¼</span>
                </div>
                <div class="space-y-1">
                    <label class="block text-slate-500 text-[10px] font-black uppercase">é«˜åº¦ (A)</label>
                    <input type="number" id="dimA" oninput="manualCalculate()" class="w-full p-3 border-2 border-slate-200 rounded-xl text-center font-black text-xl text-slate-800 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="block text-slate-500 text-[10px] font-black uppercase">å¯¬åº¦ (B)</label>
                    <input type="number" id="dimB" oninput="manualCalculate()" class="w-full p-3 border-2 border-slate-200 rounded-xl text-center font-black text-xl text-slate-800 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="block text-slate-500 text-[10px] font-black uppercase">åšåº¦ 1 (t1)</label>
                    <input type="number" id="dimT1" oninput="manualCalculate()" class="w-full p-3 border-2 border-slate-200 rounded-xl text-center font-black text-xl text-slate-800 outline-none">
                </div>
                <div class="space-y-1">
                    <label class="block text-slate-500 text-[10px] font-black uppercase">åšåº¦ 2 (t2)</label>
                    <input type="number" id="dimT2" oninput="manualCalculate()" class="w-full p-3 border-2 border-slate-200 rounded-xl text-center font-black text-xl text-slate-800 outline-none">
                </div>
            </div>

            <!-- è¨ˆç®—çµæœ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
                <div>
                    <label class="block text-slate-700 font-bold mb-4 text-lg flex items-center gap-3">
                        <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">4</span>
                        è¼¸å…¥é•·åº¦ (m)
                    </label>
                    <input type="number" id="lenInput" value="1" step="0.1" oninput="manualCalculate()" class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:ring-4 focus:ring-blue-500/20 outline-none text-3xl font-mono font-black text-blue-600">
                </div>
                <div class="bg-blue-600 rounded-[2rem] p-6 text-white flex flex-col justify-center shadow-xl shadow-blue-100">
                    <span class="text-blue-100 text-xs uppercase tracking-[0.2em] font-black mb-1">è¨ˆç®—ç¸½é‡é‡</span>
                    <div class="flex items-baseline gap-2">
                        <span id="totalRes" class="total-weight-number font-black italic tracking-tight">0.00</span>
                        <span class="text-xl font-bold">kg</span>
                    </div>
                </div>
            </div>

            <!-- è©³ç´°è³‡è¨Š -->
            <div id="detailInfo" class="hidden bg-slate-900 rounded-[2rem] p-6 text-white">
                <div class="flex justify-between items-center gap-4">
                    <div class="flex-1 text-center">
                        <span class="text-slate-400 text-[10px] font-black block mb-1 uppercase">å–®ä½é‡ (kg/m)</span>
                        <span id="unitRes" class="font-black text-blue-400 text-2xl font-mono">0.000</span>
                    </div>
                    <div class="h-10 w-[1px] bg-slate-700"></div>
                    <div class="flex-1 text-center">
                        <span class="text-slate-400 text-[10px] font-black block mb-1 uppercase">é¡åˆ¥</span>
                        <span id="typeRes" class="font-black text-white text-xl truncate px-2 block">---</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const database = {};
        let currentCategory = "";
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileStatus = document.getElementById('fileStatus');
        const queryUI = document.getElementById('queryUI');
        const categoryGrid = document.getElementById('categoryGrid');
        const sizeSelect = document.getElementById('sizeSelect');
        const adjustableFields = document.getElementById('adjustableFields');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        };

        async function handleFiles(files) {
            for (let file of files) {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                const categoryName = file.name.replace(/\.[^/.]+$/, "").trim();
                processExcelData(categoryName, jsonData);
            }
            updateUI();
        }

        function processExcelData(category, rows) {
            if (!database[category]) database[category] = [];
            rows.forEach(row => {
                if (!row || row.length < 2) return;
                const filteredRow = row.filter(cell => cell !== null && cell !== undefined && cell !== "");
                if (filteredRow.length < 2) return;
                const nameValue = String(filteredRow[0]).trim();
                const weightValue = parseFloat(filteredRow[filteredRow.length - 1]);
                if (!isNaN(weightValue) && weightValue > 0 && nameValue.length > 1 && !nameValue.includes("è¦æ ¼") && !nameValue.includes("å“å")) {
                    database[category].push({ name: nameValue, weight: weightValue });
                }
            });
        }

        function updateUI() {
            if (Object.keys(database).length === 0) return;
            categoryGrid.innerHTML = '';
            Object.keys(database).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn p-3 text-base font-black border-2 border-slate-200 rounded-2xl hover:bg-slate-50 transition-all bg-white shadow-sm';
                btn.textContent = cat;
                btn.onclick = () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active-category'));
                    btn.classList.add('active-category');
                    currentCategory = cat;
                    loadSizes(cat);
                };
                categoryGrid.appendChild(btn);
            });
            queryUI.classList.remove('opacity-40', 'pointer-events-none');
            fileStatus.innerHTML = `<span class="bg-green-600 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg">å·²è¼‰å…¥ ${Object.keys(database).length} ä»½è¡¨æ ¼</span>`;
        }

        function loadSizes(cat) {
            const specs = database[cat];
            sizeSelect.innerHTML = `<option value="">-- é¸æ“‡è¦æ ¼ (å…± ${specs.length} é …) --</option>`;
            specs.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.weight;
                opt.dataset.name = item.name;
                opt.textContent = `${item.name} (${item.weight} kg/m)`;
                sizeSelect.appendChild(opt);
            });
            adjustableFields.classList.add('hidden');
            manualCalculate();
        }

        function handleSizeSelect() {
            const opt = sizeSelect.options[sizeSelect.selectedIndex];
            if (!opt || opt.value === "") {
                adjustableFields.classList.add('hidden');
                return;
            }
            const name = opt.dataset.name;
            adjustableFields.classList.remove('hidden');
            document.getElementById('calcModeLabel').textContent = "æ•¸æ“šæ¨¡å¼";
            document.getElementById('calcModeLabel').className = "text-[10px] bg-slate-200 text-slate-700 px-3 py-1 rounded-full font-bold";

            let parts = name.split(/[Xx*Ã—\s]/).map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
            const dimA = document.getElementById('dimA'), dimB = document.getElementById('dimB'), dimT1 = document.getElementById('dimT1'), dimT2 = document.getElementById('dimT2');

            dimA.value = parts[0] || 0;
            dimB.value = parts[1] || 0;
            dimT1.value = parts[2] || 0;
            dimT2.value = parts[3] || parts[2] || 0;

            if (currentCategory.includes("è§’é‹¼") && parts.length === 2) {
                dimA.value = parts[0]; dimB.value = parts[0]; dimT1.value = parts[1]; dimT2.value = parts[1];
            } else if (currentCategory.includes("é‹¼ç­‹")) {
                dimB.value = 0; dimT1.value = 0; dimT2.value = 0;
                const rebarMatch = name.match(/D(\d+)/);
                if(rebarMatch) dimA.value = rebarMatch[1];
            }
            manualCalculate(true);
        }

        function manualCalculate(isInitial = false) {
            const a = parseFloat(document.getElementById('dimA').value) || 0, b = parseFloat(document.getElementById('dimB').value) || 0, t1 = parseFloat(document.getElementById('dimT1').value) || 0, t2 = parseFloat(document.getElementById('dimT2').value) || 0, len = parseFloat(document.getElementById('lenInput').value) || 0;
            let unitWeight = 0;
            const selectedOpt = sizeSelect.options[sizeSelect.selectedIndex];

            if (!isInitial) {
                document.getElementById('calcModeLabel').textContent = "å…¬å¼é‡ç®—";
                document.getElementById('calcModeLabel').className = "text-[10px] bg-amber-100 text-amber-700 px-3 py-1 rounded-full font-bold";
            }

            if (isInitial && selectedOpt && selectedOpt.value) {
                unitWeight = parseFloat(selectedOpt.value);
            } else if (a > 0) {
                const density = 0.785;
                if (currentCategory.includes("Hå‹é‹¼") || currentCategory.includes("Iå‹é‹¼") || currentCategory.includes("æ§½é‹¼")) {
                    unitWeight = ((a * t1) + 2 * (b - t1) * t2) / 100 * density;
                } else if (currentCategory.includes("è§’é‹¼")) {
                    unitWeight = ((a + b - t1) * t1) / 100 * density;
                } else if (currentCategory.includes("é‹¼ç­‹")) {
                    unitWeight = (Math.PI * Math.pow(a/20, 2)) * density;
                } else {
                    unitWeight = selectedOpt ? parseFloat(selectedOpt.value) : 0;
                }
            }

            const total = unitWeight * len;
            const detailInfo = document.getElementById('detailInfo');
            if (unitWeight > 0) {
                document.getElementById('totalRes').textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('unitRes').textContent = unitWeight.toFixed(3);
                document.getElementById('typeRes').textContent = currentCategory;
                detailInfo.classList.remove('hidden');
            } else {
                document.getElementById('totalRes').textContent = '0.00';
                detailInfo.classList.add('hidden');
            }
        }
    </script>
</body>
</html>